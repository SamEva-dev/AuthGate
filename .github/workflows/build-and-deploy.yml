name: Build & Deploy (branches)

on:
  push:
    branches: ["main", "preprod", "staging"]

concurrency:
  group: authgate-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set env tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          case "${GITHUB_REF_NAME}" in
            main)    echo "env=prod" >> "$GITHUB_OUTPUT" ;;
            preprod) echo "env=preprod" >> "$GITHUB_OUTPUT" ;;
            staging) echo "env=staging" >> "$GITHUB_OUTPUT" ;;
            *) echo "Unsupported branch: ${GITHUB_REF_NAME}" >&2; exit 1 ;;
          esac
          echo "sha_tag=sha-${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/authgate:${{ steps.tag.outputs.env }}
            ${{ secrets.DOCKERHUB_USERNAME }}/authgate:${{ steps.tag.outputs.sha_tag }}

      - name: Deploy (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail

            ENV_NAME="${{ steps.tag.outputs.env }}"
            IMAGE_TAG="sha-${{ github.sha }}"

            cd /opt/locaguest

            # Docker login (évite d'exposer le token dans l'historique : password-stdin)
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            upsert_env () {
              local key="$1"
              local value="$2"
              if [ ! -f .env ]; then touch .env; fi
              if grep -qE "^${key}=" .env; then
                sed -i "s|^${key}=.*|${key}=${value}|" .env
              else
                echo "${key}=${value}" >> .env
              fi
            }

            # Met à jour le tag utilisé par compose pour l'env ciblé
            if [ "${ENV_NAME}" = "staging" ]; then
              upsert_env "AUTHGATE_TAG_STAGING" "${IMAGE_TAG}"
              docker compose --profile staging pull authgate-staging
              docker compose --profile staging up -d authgate-db-staging authgate-staging
              docker compose --profile staging ps
            fi

            if [ "${ENV_NAME}" = "preprod" ]; then
              upsert_env "AUTHGATE_TAG_PREPROD" "${IMAGE_TAG}"
              docker compose --profile preprod pull authgate-preprod
              docker compose --profile preprod up -d authgate-db-preprod authgate-preprod
              docker compose --profile preprod ps
            fi

            if [ "${ENV_NAME}" = "prod" ]; then
              upsert_env "AUTHGATE_TAG_PROD" "${IMAGE_TAG}"
              docker compose --profile prod pull authgate-prod
              docker compose --profile prod up -d authgate-db-prod authgate-prod
              docker compose --profile prod ps
            fi

            # S'assure que Caddy tourne (HTTPS)
            docker compose up -d caddy
