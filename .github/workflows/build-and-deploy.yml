- name: Prepare SSH
  shell: bash
  run: |
    set -euo pipefail
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh

    # Write private key from multi-line secret (NO base64)
    printf '%s' "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519_locaguest
    chmod 600 ~/.ssh/id_ed25519_locaguest

    ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts
    chmod 600 ~/.ssh/known_hosts

- name: SSH connectivity test
  shell: bash
  run: |
    ssh -i ~/.ssh/id_ed25519_locaguest -o IdentitiesOnly=yes \
      "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
      "whoami && docker version && docker compose version"
