name: Deploy

on:
  workflow_run:
    workflows: ["Build & Push"]
    types: [completed]

  workflow_dispatch:
    inputs:
      target_env:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - preprod
          - prod
      image_tag:
        description: "Docker image tag (example: sha-<commit>)"
        required: true
        type: string

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy_staging:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Compute IMAGE_TAG from workflow_run SHA
        run: echo "IMAGE_TAG=sha-${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV

      - name: Deploy to VPS (staging)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            cd "${{ secrets.DEPLOY_PATH }}"

            # Upsert tag in env file (example variable name; adapte Ã  ton compose)
            ENV_FILE="${{ secrets.ENV_FILE }}"
            KEY="AUTHGATE_TAG_STAGING"
            VALUE="${IMAGE_TAG}"

            sudo test -f "$ENV_FILE" || sudo install -m 600 /dev/null "$ENV_FILE"
            if sudo grep -qE "^${KEY}=" "$ENV_FILE"; then
              sudo sed -i "s|^${KEY}=.*|${KEY}=${VALUE}|" "$ENV_FILE"
            else
              echo "${KEY}=${VALUE}" | sudo tee -a "$ENV_FILE" >/dev/null
            fi

            sudo docker compose --env-file "$ENV_FILE" --profile staging pull locaguest-api-staging
            sudo docker compose --env-file "$ENV_FILE" --profile staging up -d --no-build locaguest-api-staging
            sudo docker ps --filter "name=locaguest-api-staging" --format "table {{.Names}}\t{{.Status}}"

  deploy_promote:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}

    steps:
      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_ENV

      - name: Deploy to VPS (preprod/prod)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            cd "${{ secrets.DEPLOY_PATH }}"

            ENV_FILE="${{ secrets.ENV_FILE }}"

            if [ "${{ inputs.target_env }}" = "preprod" ]; then
              KEY="AUTHGATE_TAG_PREPROD"
              SERVICE="authgate-preprod"
              PROFILE="preprod"
            else
              KEY="AUTHGATE_TAG_PROD"
              SERVICE="authgate-prod"
              PROFILE="prod"
            fi

            sudo test -f "$ENV_FILE" || sudo install -m 600 /dev/null "$ENV_FILE"
            if sudo grep -qE "^${KEY}=" "$ENV_FILE"; then
              sudo sed -i "s|^${KEY}=.*|${KEY}=${IMAGE_TAG}|" "$ENV_FILE"
            else
              echo "${KEY}=${IMAGE_TAG}" | sudo tee -a "$ENV_FILE" >/dev/null
            fi

            sudo docker compose --env-file "$ENV_FILE" --profile "$PROFILE" pull "$SERVICE"
            sudo docker compose --env-file "$ENV_FILE" --profile "$PROFILE" up -d --no-build "$SERVICE"
            sudo docker ps --filter "name=$SERVICE" --format "table {{.Names}}\t{{.Status}}"
